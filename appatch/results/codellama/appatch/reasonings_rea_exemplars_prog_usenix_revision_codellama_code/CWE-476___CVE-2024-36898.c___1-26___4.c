1 static int edge_detector_setup(struct line *line,
2 			       struct gpio_v2_line_config *lc,
3 			       unsigned int line_idx, u64 edflags)
5 	u32 debounce_period_us;
6 	unsigned long irqflags = 0;
7 	u64 eflags;
8 	int irq, ret;
10 	eflags = edflags & GPIO_V2_LINE_EDGE_FLAGS;
11 	if (eflags && !kfifo_initialized(&line->req->events)) {
12 		ret = kfifo_alloc(&line->req->events,
13 				  line->req->event_buffer_size, GFP_KERNEL);
14 		if (ret)
15 			return ret;
17 	if (gpio_v2_line_config_debounced(lc, line_idx)) {
18 		debounce_period_us = gpio_v2_line_config_debounce_period(lc, line_idx);
19 		ret = debounce_setup(line, debounce_period_us);
20 		if (ret)
21 			return ret;
22 		line_set_debounce_period(line, debounce_period_us);
26 	if (!eflags || READ_ONCE(line->sw_debounced))

8434 static bool gpio_v2_line_config_debounced(struct gpio_v2_line_config *lc,
8435 					  unsigned int line_idx)
8437 	unsigned int i;
8438 	u64 mask = BIT_ULL(line_idx);
8440 	for (i = 0; i < lc->num_attrs; i++) {
8441 		if ((lc->attrs[i].attr.id == GPIO_V2_LINE_ATTR_ID_DEBOUNCE) &&
8442 		    (lc->attrs[i].mask & mask))
8443 			return true;
8445 	return false;


8353 static u32 gpio_v2_line_config_debounce_period(struct gpio_v2_line_config *lc,
8354 					       unsigned int line_idx)
8356 	unsigned int i;
8357 	u64 mask = BIT_ULL(line_idx);
8359 	for (i = 0; i < lc->num_attrs; i++) {
8360 		if ((lc->attrs[i].attr.id == GPIO_V2_LINE_ATTR_ID_DEBOUNCE) &&
8361 		    (lc->attrs[i].mask & mask))
8362 			return lc->attrs[i].attr.debounce_period_us;
8364 	return 0;


8744 static int debounce_setup(struct line *line, unsigned int debounce_period_us)
8746 	unsigned long irqflags;
8747 	int ret, level, irq;
8750 	ret = gpiod_set_debounce(line->desc, debounce_period_us);


8434 static bool gpio_v2_line_config_debounced(struct gpio_v2_line_config *lc,
8435 					  unsigned int line_idx)
8437 	unsigned int i;
8438 	u64 mask = BIT_ULL(line_idx);
8440 	for (i = 0; i < lc->num_attrs; i++) {
8441 		if ((lc->attrs[i].attr.id == GPIO_V2_LINE_ATTR_ID_DEBOUNCE) &&
8442 		    (lc->attrs[i].mask & mask))
8443 			return true;
8445 	return false;


8353 static u32 gpio_v2_line_config_debounce_period(struct gpio_v2_line_config *lc,
8354 					       unsigned int line_idx)
8356 	unsigned int i;
8357 	u64 mask = BIT_ULL(line_idx);
8359 	for (i = 0; i < lc->num_attrs; i++) {
8360 		if ((lc->attrs[i].attr.id == GPIO_V2_LINE_ATTR_ID_DEBOUNCE) &&
8361 		    (lc->attrs[i].mask & mask))
8362 			return lc->attrs[i].attr.debounce_period_us;
8364 	return 0;


8744 static int debounce_setup(struct line *line, unsigned int debounce_period_us)
8746 	unsigned long irqflags;
8747 	int ret, level, irq;
8750 	ret = gpiod_set_debounce(line->desc, debounce_period_us);
