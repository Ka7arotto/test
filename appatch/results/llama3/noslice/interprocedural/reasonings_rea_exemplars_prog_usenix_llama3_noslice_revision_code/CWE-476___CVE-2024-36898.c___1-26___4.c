1 static int edge_detector_setup(struct line *line,
2 			       struct gpio_v2_line_config *lc,
3 			       unsigned int line_idx, u64 edflags)
4 {
5 	u32 debounce_period_us;
6 	unsigned long irqflags = 0;
7 	u64 eflags;
8 	int irq, ret;
9 
10 	eflags = edflags & GPIO_V2_LINE_EDGE_FLAGS;
11 	if (eflags && !kfifo_initialized(&line->req->events)) {
12 		ret = kfifo_alloc(&line->req->events,
13 				  line->req->event_buffer_size, GFP_KERNEL);
14 		if (ret)
15 			return ret;
16 	}
17 	if (gpio_v2_line_config_debounced(lc, line_idx)) {
18 		debounce_period_us = gpio_v2_line_config_debounce_period(lc, line_idx);
19 		ret = debounce_setup(line, debounce_period_us);
20 		if (ret)
21 			return ret;
22 		line_set_debounce_period(line, debounce_period_us);
23 	}
24 
25 	/* detection disabled or sw debouncer will provide edge detection */
26 	if (!eflags || READ_ONCE(line->sw_debounced))
27 		return 0;
28 
29 	if (IS_ENABLED(CONFIG_HTE) &&
30 	    (edflags & GPIO_V2_LINE_FLAG_EVENT_CLOCK_HTE))
31 		return hte_edge_setup(line, edflags);
32 
33 	irq = gpiod_to_irq(line->desc);
34 	if (irq < 0)
35 		return -ENXIO;
36 
37 	if (eflags & GPIO_V2_LINE_FLAG_EDGE_RISING)
38 		irqflags |= test_bit(FLAG_ACTIVE_LOW, &line->desc->flags) ?
39 			IRQF_TRIGGER_FALLING : IRQF_TRIGGER_RISING;
40 	if (eflags & GPIO_V2_LINE_FLAG_EDGE_FALLING)
41 		irqflags |= test_bit(FLAG_ACTIVE_LOW, &line->desc->flags) ?
42 			IRQF_TRIGGER_RISING : IRQF_TRIGGER_FALLING;
43 	irqflags |= IRQF_ONESHOT;
44 
45 	/* Request a thread to read the events */
46 	ret = request_threaded_irq(irq, edge_irq_handler, edge_irq_thread,
47 				   irqflags, line->req->label, line);
48 	if (ret)
49 		return ret;
50 
51 	line->irq = irq;
52 	return 0;
53 }


static int edge_detector_update(struct line *line,
				struct gpio_v2_line_config *lc,
				unsigned int line_idx, u64 edflags)
{
	u64 active_edflags = READ_ONCE(line->edflags);
	unsigned int debounce_period_us =
			gpio_v2_line_config_debounce_period(lc, line_idx);

	if ((active_edflags == edflags) &&
	    (READ_ONCE(line->debounce_period_us) == debounce_period_us))
		return 0;

	/* sw debounced and still will be...*/
	if (debounce_period_us && READ_ONCE(line->sw_debounced)) {
		line_set_debounce_period(line, debounce_period_us);
		return 0;
	}

	/* reconfiguring edge detection or sw debounce being disabled */
	if ((line->irq && !READ_ONCE(line->sw_debounced)) ||
	    (active_edflags & GPIO_V2_LINE_FLAG_EVENT_CLOCK_HTE) ||
	    (!debounce_period_us && READ_ONCE(line->sw_debounced)))
		edge_detector_stop(line);

	return edge_detector_setup(line, lc, line_idx, edflags);
}
