c
< 	buffer = vmemdup_user(buf, lbuf);
---
> 	buffer = kvmalloc(lbuf, GFP_KERNEL);
> 	if (!buffer) {
> 		return -ENOMEM;
> 	}
> 	if (copy_from_user(buffer, buf, lbuf)) {
> 		kvfree(buffer);
> 		return -EFAULT;
> 	}
