
<     if (ret < 0)
<         goto fail;
---
>     if (ret < 0) {
>         // Call cleanup function here
>         // Reset state here
>         goto fail;
>     }
