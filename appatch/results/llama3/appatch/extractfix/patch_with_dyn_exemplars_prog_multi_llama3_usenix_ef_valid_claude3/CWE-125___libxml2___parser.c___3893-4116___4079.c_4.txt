c
< while (buf[len - 1] == 0x20) len--;
---
> if (len > 0) {
>     int i = len - 1;
>     while (i >= 0 && buf[i] == 0x20) {
>         i--;
>         len--;
>     }
> }
