c
< while (buf[len - 1] == 0x20) len--;
---
> if (len > 0 && buf[len - 1] == 0x20) {
>     while (buf[len - 1] == 0x20) len--;
> }
