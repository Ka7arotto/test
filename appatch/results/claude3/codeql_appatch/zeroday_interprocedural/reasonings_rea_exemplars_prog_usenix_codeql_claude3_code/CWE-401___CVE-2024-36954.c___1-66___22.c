1 int tipc_buf_append(struct sk_buff **headbuf, struct sk_buff **buf)
3 	struct sk_buff *head = *headbuf;
4 	struct sk_buff *frag = *buf;
5 	struct sk_buff *tail = NULL;
6 	struct tipc_msg *msg;
7 	u32 fragid;
8 	int delta;
9 	bool headstolen;
11 	if (!frag)
12 		goto err;
14 	msg = buf_msg(frag);
15 	fragid = msg_type(msg);
16 	frag->next = NULL;
17 	skb_pull(frag, msg_hdr_sz(msg));
19 	if (fragid == FIRST_FRAGMENT) {
20 		if (unlikely(head))
21 			goto err;
23 		if (skb_has_frag_list(frag) && __skb_linearize(frag))
24 			goto err;
25 		frag = skb_unshare(frag, GFP_ATOMIC);
26 		if (unlikely(!frag))
27 			goto err;
28 		head = *headbuf = frag;
29 		TIPC_SKB_CB(head)->tail = NULL;
30 		return 0;
33 	if (!head)
34 		goto err;
36 	if (skb_try_coalesce(head, frag, &headstolen, &delta)) {
37 		kfree_skb_partial(frag, headstolen);
39 		tail = TIPC_SKB_CB(head)->tail;
40 		if (!skb_has_frag_list(head))
41 			skb_shinfo(head)->frag_list = frag;
42 		else
43 			tail->next = frag;
44 		head->truesize += frag->truesize;
45 		head->data_len += frag->len;
46 		head->len += frag->len;
47 		TIPC_SKB_CB(head)->tail = frag;
50 	if (fragid == LAST_FRAGMENT) {
51 		TIPC_SKB_CB(head)->validated = false;
52 		if (unlikely(!tipc_msg_validate(&head)))
53 			goto err;
55 		TIPC_SKB_CB(head)->tail = NULL;
57 		return 1;
60 	return 0;
61 err:
62 	kfree_skb(*buf);
63 	kfree_skb(*headbuf);