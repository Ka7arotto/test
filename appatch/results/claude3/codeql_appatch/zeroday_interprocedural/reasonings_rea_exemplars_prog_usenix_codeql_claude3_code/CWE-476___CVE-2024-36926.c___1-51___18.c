1 #define PCI_DN(dn)	((struct pci_dn *) (dn)->data)
3 static void pci_dma_bus_setup_pSeriesLP(struct pci_bus *bus)
5 	struct iommu_table *tbl;
6 	struct device_node *dn, *pdn;
7 	struct pci_dn *ppci;
8 	struct dynamic_dma_window_prop prop;
10 	dn = pci_bus_to_OF_node(bus);
12 	pr_debug("pci_dma_bus_setup_pSeriesLP: setting up bus %pOF\n",
13 		 dn);
15 	pdn = pci_dma_find(dn, &prop);
23 	ppci = PCI_DN(pdn);
25 	pr_debug("  parent is %pOF, iommu_table: 0x%p\n",
26 		 pdn, ppci->table_group);
28 	if (!ppci->table_group) {
29 		ppci->table_group = iommu_pseries_alloc_group(ppci->phb->node);
30 		tbl = ppci->table_group->tables[0];
32 		iommu_table_setparms_common(tbl, ppci->phb->bus->number,
33 				be32_to_cpu(prop.liobn),
34 				be64_to_cpu(prop.dma_base),
35 				1ULL << be32_to_cpu(prop.window_shift),
36 				be32_to_cpu(prop.tce_shift), NULL,
37 				&iommu_table_lpar_multi_ops);
43 		ppci->table_group->tce32_start = be64_to_cpu(prop.dma_base);
44 		ppci->table_group->tce32_size = 1 << be32_to_cpu(prop.window_shift);
46 		if (!iommu_init_table(tbl, ppci->phb->node, 0, 0))
47 			panic("Failed to initialize iommu table");
49 		iommu_register_group(ppci->table_group,