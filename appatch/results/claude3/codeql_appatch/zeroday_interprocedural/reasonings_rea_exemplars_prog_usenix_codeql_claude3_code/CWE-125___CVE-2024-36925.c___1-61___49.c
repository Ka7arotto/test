1 static int rmem_swiotlb_device_init(struct reserved_mem *rmem,
2 				    struct device *dev)
4 	struct io_tlb_mem *mem = rmem->priv;
5 	unsigned long nslabs = rmem->size >> IO_TLB_SHIFT;
8 	unsigned int nareas = 1;
10 	if (PageHighMem(pfn_to_page(PHYS_PFN(rmem->base)))) {
11 		dev_err(dev, "Restricted DMA pool must be accessible within the linear mapping.");
12 		return -EINVAL;
20 	if (!mem) {
21 		struct io_tlb_pool *pool;
23 		mem = kzalloc(sizeof(*mem), GFP_KERNEL);
24 		if (!mem)
25 			return -ENOMEM;
26 		pool = &mem->defpool;
28 		pool->slots = kcalloc(nslabs, sizeof(*pool->slots), GFP_KERNEL);
29 		if (!pool->slots) {
30 			kfree(mem);
31 			return -ENOMEM;
34 		pool->areas = kcalloc(nareas, sizeof(*pool->areas),
35 				GFP_KERNEL);
36 		if (!pool->areas) {
37 			kfree(pool->slots);
38 			kfree(mem);
39 			return -ENOMEM;
42 		set_memory_decrypted((unsigned long)phys_to_virt(rmem->base),
43 				     rmem->size >> PAGE_SHIFT);
44 		swiotlb_init_io_tlb_pool(pool, rmem->base, nslabs,