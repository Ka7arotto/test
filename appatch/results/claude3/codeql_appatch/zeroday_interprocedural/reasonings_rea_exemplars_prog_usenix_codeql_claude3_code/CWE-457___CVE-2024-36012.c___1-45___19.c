1 void hci_unregister_dev(struct hci_dev *hdev)
3 	BT_DBG("%p name %s bus %d", hdev, hdev->name, hdev->bus);
5 	mutex_lock(&hdev->unregister_lock);
6 	hci_dev_set_flag(hdev, HCI_UNREGISTER);
7 	mutex_unlock(&hdev->unregister_lock);
9 	write_lock(&hci_dev_list_lock);
10 	list_del(&hdev->list);
11 	write_unlock(&hci_dev_list_lock);
13 	cancel_work_sync(&hdev->power_on);
15 	hci_cmd_sync_clear(hdev);
17 	hci_unregister_suspend_notifier(hdev);
19 	msft_unregister(hdev);
21 	hci_dev_do_close(hdev);
23 	if (!test_bit(HCI_INIT, &hdev->flags) &&
24 	    !hci_dev_test_flag(hdev, HCI_SETUP) &&
25 	    !hci_dev_test_flag(hdev, HCI_CONFIG)) {
26 		hci_dev_lock(hdev);
27 		mgmt_index_removed(hdev);
28 		hci_dev_unlock(hdev);
33 	BUG_ON(!list_empty(&hdev->mgmt_pending));
35 	hci_sock_dev_event(hdev, HCI_DEV_UNREG);
37 	if (hdev->rfkill) {
38 		rfkill_unregister(hdev->rfkill);