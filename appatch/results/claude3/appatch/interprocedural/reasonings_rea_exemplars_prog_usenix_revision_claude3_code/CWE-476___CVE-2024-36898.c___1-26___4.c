1 static int edge_detector_setup(struct line *line,
2 			       struct gpio_v2_line_config *lc,
3 			       unsigned int line_idx, u64 edflags)
5 	u32 debounce_period_us;
6 	unsigned long irqflags = 0;
7 	u64 eflags;
8 	int irq, ret;
10 	eflags = edflags & GPIO_V2_LINE_EDGE_FLAGS;
11 	if (eflags && !kfifo_initialized(&line->req->events)) {
12 		ret = kfifo_alloc(&line->req->events,
13 				  line->req->event_buffer_size, GFP_KERNEL);
14 		if (ret)
15 			return ret;
17 	if (gpio_v2_line_config_debounced(lc, line_idx)) {
18 		debounce_period_us = gpio_v2_line_config_debounce_period(lc, line_idx);
19 		ret = debounce_setup(line, debounce_period_us);
20 		if (ret)
21 			return ret;
22 		line_set_debounce_period(line, debounce_period_us);
26 	if (!eflags || READ_ONCE(line->sw_debounced))

985 static int edge_detector_update(struct line *line,
986 				struct gpio_v2_line_config *lc,
987 				unsigned int line_idx, u64 edflags)
989 	u64 active_edflags = READ_ONCE(line->edflags);
990 	unsigned int debounce_period_us =
991 			gpio_v2_line_config_debounce_period(lc, line_idx);
993 	if ((active_edflags == edflags) &&
994 	    (READ_ONCE(line->debounce_period_us) == debounce_period_us))
995 		return 0;
998 	if (debounce_period_us && READ_ONCE(line->sw_debounced)) {
999 		line_set_debounce_period(line, debounce_period_us);
1000 		return 0;
1004 	if ((line->irq && !READ_ONCE(line->sw_debounced)) ||
1005 	    (active_edflags & GPIO_V2_LINE_FLAG_EVENT_CLOCK_HTE) ||
1006 	    (!debounce_period_us && READ_ONCE(line->sw_debounced)))
1007 		edge_detector_stop(line);
1009 	return edge_detector_setup(line, lc, line_idx, edflags);
