
<         int es = samplesperpixel - nc;
---
>         int es = (samplesperpixel > nc) ? (samplesperpixel - nc) : 1;
