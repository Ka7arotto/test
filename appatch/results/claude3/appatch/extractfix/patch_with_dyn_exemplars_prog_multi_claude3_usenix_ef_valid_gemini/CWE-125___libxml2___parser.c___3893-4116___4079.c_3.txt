
< while (buf[len - 1] == 0x20) len--;
---
> if (len > 0) {
>     while (buf[len - 1] == 0x20) {
>         len--;
>         if (len == 0) break;
>     }
> }
