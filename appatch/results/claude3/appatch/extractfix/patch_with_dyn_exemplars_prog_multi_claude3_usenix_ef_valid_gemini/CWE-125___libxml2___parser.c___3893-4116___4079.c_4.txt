
< while (buf[len - 1] == 0x20) len--;
---
> size_t i = len;
> while (i > 0 && buf[i - 1] == 0x20) i--;
> len = i;
