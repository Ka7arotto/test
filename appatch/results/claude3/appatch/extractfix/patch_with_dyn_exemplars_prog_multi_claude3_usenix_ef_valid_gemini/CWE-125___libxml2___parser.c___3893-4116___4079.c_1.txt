
< while (buf[len - 1] == 0x20) len--;
---
> if (len > 0) {
>     do {
>         len--;
>     } while (len > 0 && buf[len] == 0x20);
>     len++;
> }
