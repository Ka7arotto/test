diff
+ size_t buf_size = bufsize;
- while (i < sizeof(buf) && (pg - page < len) &&
+ while (i < buf_size && (pg - page < len) &&
