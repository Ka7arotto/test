1 int smc_ib_find_route(struct net *net, __be32 saddr, __be32 daddr,
2 		      u8 nexthop_mac[], u8 *uses_gateway)
4 	struct neighbour *neigh = NULL;
5 	struct rtable *rt = NULL;
6 	struct flowi4 fl4 = {
7 		.saddr = saddr,
8 		.daddr = daddr
11 	if (daddr == cpu_to_be32(INADDR_NONE))
12 		goto out;
13 	rt = ip_route_output_flow(net, &fl4, NULL);
14 	if (IS_ERR(rt))
15 		goto out;
16 	if (rt->rt_uses_gateway && rt->rt_gw_family != AF_INET)
17 		goto out;
18 	neigh = rt->dst.ops->neigh_lookup(&rt->dst, NULL, &fl4.daddr);
19 	if (neigh) {
20 		memcpy(nexthop_mac, neigh->ha, ETH_ALEN);