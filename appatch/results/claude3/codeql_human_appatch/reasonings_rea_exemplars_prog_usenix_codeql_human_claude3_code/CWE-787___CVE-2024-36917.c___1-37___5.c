1 static int blk_ioctl_discard(struct block_device *bdev, blk_mode_t mode,
2 		unsigned long arg)
4 	uint64_t range[2];
5 	uint64_t start, len;
6 	struct inode *inode = bdev->bd_inode;
7 	int err;
9 	if (!(mode & BLK_OPEN_WRITE))
10 		return -EBADF;
12 	if (!bdev_max_discard_sectors(bdev))
13 		return -EOPNOTSUPP;
15 	if (copy_from_user(range, (void __user *)arg, sizeof(range)))
16 		return -EFAULT;
18 	start = range[0];
19 	len = range[1];
21 	if (start & 511)
22 		return -EINVAL;
23 	if (len & 511)
24 		return -EINVAL;
26 	if (start + len > bdev_nr_bytes(bdev))
27 		return -EINVAL;
29 	filemap_invalidate_lock(inode->i_mapping);
30 	err = truncate_bdev_range(bdev, mode, start, start + len - 1);
31 	if (err)
32 		goto fail;
33 	err = blkdev_issue_discard(bdev, start >> 9, len >> 9, GFP_KERNEL);
34 fail:
35 	filemap_invalidate_unlock(inode->i_mapping);