1 static int register_device(int minor, struct pp_struct *pp)
3 	struct parport *port;
4 	struct pardevice *pdev = NULL;
5 	char *name;
6 	struct pardev_cb ppdev_cb;
7 	int rc = 0, index;
9 	name = kasprintf(GFP_KERNEL, CHRDEV "%x", minor);
10 	if (name == NULL)
11 		return -ENOMEM;
13 	port = parport_find_number(minor);
14 	if (!port) {
15 		pr_warn("%s: no associated port!\n", name);
16 		rc = -ENXIO;
17 		goto err;
20 	index = ida_alloc(&ida_index, GFP_KERNEL);
21 	memset(&ppdev_cb, 0, sizeof(ppdev_cb));
22 	ppdev_cb.irq_func = pp_irq;
23 	ppdev_cb.flags = (pp->flags & PP_EXCL) ? PARPORT_FLAG_EXCL : 0;
24 	ppdev_cb.private = pp;
25 	pdev = parport_register_dev_model(port, name, &ppdev_cb, index);
26 	parport_put_port(port);
28 	if (!pdev) {
29 		pr_warn("%s: failed to register device!\n", name);
30 		rc = -ENXIO;
31 		ida_free(&ida_index, index);
32 		goto err;
35 	pp->pdev = pdev;
36 	pp->index = index;
37 	dev_dbg(&pdev->dev, "registered pardevice\n");
38 err:
39 	kfree(name);