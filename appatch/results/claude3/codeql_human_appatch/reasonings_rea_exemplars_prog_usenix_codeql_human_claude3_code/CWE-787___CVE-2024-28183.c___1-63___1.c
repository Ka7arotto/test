1 static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)
5     if (!do_load && checksum == NULL) {
6         ESP_LOGD(TAG, "skipping checksum for segment");
7         return ESP_OK;
10     const uint32_t *data = (const uint32_t *)bootloader_mmap(data_addr, data_len);
11     if (!data) {
12         ESP_LOGE(TAG, "bootloader_mmap(0x%x, 0x%x) failed",
13                  data_addr, data_len);
14         return ESP_FAIL;
17     if (checksum == NULL && sha_handle == NULL) {
18         memcpy((void *)load_addr, data, data_len);
19         bootloader_munmap(data);
20         return ESP_OK;
23 #ifdef BOOTLOADER_BUILD
25     while (ram_obfs_value[0] == 0 || ram_obfs_value[1] == 0) {
26         bootloader_fill_random(ram_obfs_value, sizeof(ram_obfs_value));
27 #if CONFIG_IDF_ENV_FPGA
29         ram_obfs_value[0] ^= 0x33;
30         ram_obfs_value[1] ^= 0x66;
31 #endif
33     uint32_t *dest = (uint32_t *)load_addr;
34 #endif
36     const uint32_t *src = data;
38     for (size_t i = 0; i < data_len; i += 4) {
39         int w_i = i / 4; // Word index
40         uint32_t w = src[w_i];