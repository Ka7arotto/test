c
// Introduce a mutex in the qeth_card structure
struct qeth_card {
    ...
    struct mutex queue_lock;
    ...
};

// Use mutex to synchronize
5  mutex_lock(&card->queue_lock);
6  if (card->qdio.no_out_queues == max) {
7      mutex_unlock(&card->queue_lock);
8      return;
9  }
10 card->qdio.no_out_queues = max;
11 if (atomic_read(&card->qdio.state) != QETH_QDIO_UNINITIALIZED)
12     qeth_free_qdio_queues(card);
13 mutex_unlock(&card->queue_lock);
