1 static void qeth_osa_set_output_queues(struct qeth_card *card, bool single)
2 {
3 	unsigned int max = single ? 1 : card->dev->num_tx_queues;
4 
5 	if (card->qdio.no_out_queues == max)
6 		return;
7 
8 	if (atomic_read(&card->qdio.state) != QETH_QDIO_UNINITIALIZED)
9 		qeth_free_qdio_queues(card);
10 
11 	if (max == 1 && card->qdio.do_prio_queueing != QETH_PRIOQ_DEFAULT)
12 		dev_info(&card->gdev->dev, "Priority Queueing not supported\n");
13 
14 	card->qdio.no_out_queues = max;
15 }


static void qeth_free_qdio_queues(struct qeth_card *card)
{
	int i, j;

	if (atomic_xchg(&card->qdio.state, QETH_QDIO_UNINITIALIZED) ==
		QETH_QDIO_UNINITIALIZED)
		return;

	qeth_free_cq(card);
	for (j = 0; j < QDIO_MAX_BUFFERS_PER_Q; ++j) {
		if (card->qdio.in_q->bufs[j].rx_skb) {
			consume_skb(card->qdio.in_q->bufs[j].rx_skb);
			card->qdio.in_q->bufs[j].rx_skb = NULL;
		}
	}

	/* inbound buffer pool */
	qeth_free_buffer_pool(card);
	/* free outbound qdio_qs */
	for (i = 0; i < card->qdio.no_out_queues; i++) {
		qeth_free_output_queue(card->qdio.out_qs[i]);
		card->qdio.out_qs[i] = NULL;
	}
}
